% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/simulate_LMMdata.r
\name{simulate_LMMdata}
\alias{simulate_LMMdata}
\title{Simulate Data from a Linear Mixed Model (LMM)}
\usage{
simulate_LMMdata(
  n_rep = 1,
  sim_settings = list(),
  distr_settings = list(),
  seed = NULL
)
}
\arguments{
\item{n_rep}{Integer scalar or length-2 vector.
If a vector of length 2, the first value gives the number of
independent simulated datasets (\code{n_sim})
and the second gives the number of within-dataset iterations (\code{n_iter}).
Within a dataset, the design matrices \code{X} and \code{Z} remain fixed
but random effects (\code{RE}) and error terms vary across iterations,
producing different response vectors (\code{y}).
If a single value is given, it is interpreted as \code{n_sim}, with \code{n_iter = 1} (default).}

\item{sim_settings}{A named list of simulation parameters,
usually constructed via \code{\link{sim_spec}} (default).
Common fields (all optional) for the mixed models include:
\describe{
\item{n_subj}{Number of subjects or clusters.}

\item{n_obs}{Integer scalar or vector (>0).
Specifies the number of observations per subject/cluster.
\itemize{
\item If a \strong{scalar} is supplied, all \code{n_subj} clusters have the same number of observations.
\item If a \strong{vector}, its length must be \code{n_subj}, and each entry gives the size of the respective cluster.
Default: \code{5} observations per cluster/subject.}
}

\item{beta_coeff}{Fixed-effect coefficient vector.
Default: a zero vector of appropriate length.}

\item{SNR}{Target signal-to-noise ratio for IID errors.
Overrides the error variance in \code{distr_settings$error_distr}.
Set to \code{NULL} (default) to disable SNR control.}

\item{X, Z}{Optional pre-specified design matrices.
May also be lists of length \code{n_sim} to allow dataset-specific designs.
If supplied, they override stochastic generation.}

\item{p, q}{Dimensions of fixed- and random-effect design matrices
(including intercept).}

\item{is.CorrelatedXZ}{Logical; If \code{TRUE}, \code{X} and \code{Z} are generated \emph{jointly}
from \code{distr_settings$XZ_distr},
and any user-supplied \code{X} or \code{Z} is ignored.}

\item{is.ZInX}{Logical. If \code{TRUE}, and \code{Z} is not supplied, the first \code{q}
columns of \code{X} (after intercept handling) are used to construct \code{Z}.}

\item{include.Xintercept, include.Zintercept}{Logical;
whether to add intercept columns in \code{X}/\code{Z}.}

\item{orthogonalize.X, orthogonalize.Z}{Logical;
If \code{TRUE}, the non-intercept columns of \code{X} and/or \code{Z}
are orthogonalized using QR decomposition.}
}}

\item{distr_settings}{A named list of distribution specifications for stochastic components.
Valid entries are: \code{error_distr}, \code{RE_distr}, \code{X_distr},
\code{Z_distr}, and \code{XZ_distr}, specifying the distributions used to
generate errors, random effects, and design matrices, respectively.
Each entry is itself a list with elements (see \code{\link{simulate_IIDdata}}):
\describe{
\item{distr_name}{Distribution name (e.g., \code{"norm"}, \code{"mvnorm"}, \code{"copula"}).}
\item{distr_params}{List of parameters for the specified distribution.}
\item{generator}{Optional user-supplied function for random generation,
enabling simulation from arbitrary or fully custom distributions.}
}
Missing or incomplete entries are automatically completed via
\code{\link{distr_spec}} with suitable dimension defaults.
The default distribution is multivariate normal with zero mean and identity covariance.
See @details for more on specification of the error distribution.}

\item{seed}{Optional integer. If provided, the random number generator (RNG)
state is temporarily replaced by this seed and restored upon exit.}
}
\value{
A named list (of class \code{"LMMdata"}) containing:
\describe{
\item{n}{Total number of observations in each simulated dataset.}
\item{y}{List of simulated response matrices of length \code{n_sim}.
Each matrix has dimension \verb{n × n_iter}.}
\item{X, Z}{List of design matrices of length \code{n_sim},
one per simulated dataset.}
\item{RE}{List of random effect realizations of length \code{n_sim}.
Each entry is either a matrix (when \code{n_iter = 1}) or
a list of matrices (one per iteration).
These matrices are of order \verb{n_subj × q}.}
\item{sigma_e}{List of error standard deviations (length \code{n_sim}).
Each entry is a vector of length \code{n_iter}.}
\item{SNR}{List of achieved signal-to-noise ratios (length \code{n_sim}).
Each entry is a vector of length \code{n_iter}.}
\item{ID}{Subject identifiers.
A factor of length equal to the total number of observations,
with \code{n_subj} levels, that aligns with the ordering of rows
in \code{y}, \code{X}, and \code{Z}.
Each level corresponds to one subject/cluster,
and repeated occurrences of a level indicate multiple observations for that subject/cluster.
}
\item{sim_settings, distr_settings}{Lists of (possibly updated) simulation and
distribution settings used to generate the data.}
}
If a list has only one single element (i.e., \code{n_sim = 1} or \code{n_iter  = 1}),
it is automatically flattened.
}
\description{
Generates datasets from a Linear Mixed Model (LMM)
with flexible control over fixed effects, random effects,
correlation structures, design matrices, and error distributions.

All stochastic components (random effects, error terms,
and design matrices when unspecified)  are generated via \code{\link{simulate_IIDdata}},
a \strong{highly general and flexible sample generator}
supporting almost all univariate and multivariate distributions.

The function supports general, possibly correlated and/or heteroscedastic,
error distributions. When the error distribution \emph{is}
independent and identically distributed (\strong{IID}, meaning all error terms share
the same distribution and are mutually independent),
users may specify a target signal-to-noise ratio (SNR).
In this case, the error variance is automatically scaled to match the desired SNR.
SNR control is not supported for non-IID errors.
}
\details{
\strong{Construction of design matrices.}
The design matrices \code{X} and \code{Z} are constructed in the following order:
\itemize{
\item If \code{is.CorrelatedXZ = TRUE},
\code{X} and \code{Z} are generated \emph{jointly} from  the distribution
specified in \code{distr_settings$XZ_distr}.
User-supplied \code{X} or \code{Z} are \strong{ignored} in this case.

\item If \code{is.CorrelatedXZ = FALSE}, user-supplied matrices take precedence:
- If \code{sim_settings$X} is supplied: \code{X} is used exactly as provided
and its column dimension updates \code{p}.
- If \code{sim_settings$Z} is supplied: \code{Z} is used exactly as provided
and its column dimension updates \code{q}.

\item If \code{X} is not supplied: \code{X} is generated using \code{distr_settings$X_distr}.

\item If \code{Z} is not supplied:
- If \code{is.ZInX = FALSE}, \code{Z} is generated from \code{distr_settings$Z_distr};
- otherwise \code{Z} is inherited from the \emph{first \code{q} columns of \code{X}}
(with correct intercept handling).

\item Intercepts are added \strong{after} stochastic generation, if requested.
\item Orthogonalization of non-intercept columns is performed last
using the \code{\link[base]{qr}} function.
}

\strong{Random effects}
Random effects are drawn per subject from \code{distr_settings$RE_distr},
with dimensions matched to the columns of \code{Z}.

\strong{Error distribution specification}
The error distribution (\code{error_distr}) may be:
\itemize{
\item \strong{Univariate} with scalar \code{sigma},
which corresponds to IID errors.

\item \strong{Multivariate}, with a covariance matrix \code{sigma}
of dimension equal to the total number of observations,
enabling arbitrary correlation and heteroscedasticity.
}
IID errors can also be represented through a multivariate specification
with diagonal covariance matrix in \code{sigma}.
If \code{sigma} is not specified in \code{error_distr$distr_params},
a default IID specification is constructed.

\strong{SNR control}
When \code{SNR} is supplied and the error distribution is IID,
the error variance is automatically scaled to achieve
the target signal-to-noise ratio
(defined as the ratio of variances of signals and errors).
SNR control is not supported for non-IID errors.

\strong{Dependencies}
Certain distribution choices (e.g., copulas) may require additional packages.
See \code{\link{simulate_IIDdata}} for details on required packages
and supported distributions.
}
\examples{

# Basic simulation
set.seed(123)
sim1 <- simulate_LMMdata()
str(sim1, max.level = 1)


# Multiple replications and iterations
sim <- simulate_LMMdata(n_rep = c(2, 3)) # 2 reps × 3 iterations
length(sim$y)         # 2 replications
dim(sim$y[[1]])       # 50 × 3 iterations (default sample size 50)


# Non-Gaussian error and multivariate random effects
distr_settings <- list(
  error_distr = list(distr_name = "t", distr_params = distr_spec(df = 4)),
  RE_distr    = list(distr_name = "mvnorm", distr_params = list(dim = 2, sigma = diag(2)))
)
sim <- simulate_LMMdata(
  n_rep = 1,
  sim_settings = sim_spec(n_subj = 15, n_obs = 5),
  distr_settings = distr_settings
)


# Correlated X and Z design matrices
Sigma_X <- matrix(c(1, 0.5, 0.5, 1), ncol = 2)
Sigma_Z <- diag(2)
Sigma_XZ <- matrix(c(0.3, 0.2, 0, 0.4), ncol = 2)
Sigma <- rbind(cbind(Sigma_X, Sigma_XZ), cbind(t(Sigma_XZ), Sigma_Z))

sim_settings <- sim_spec(
  n_subj = 10,
  n_obs  = 4,
  is.CorrelatedXZ = TRUE,
  include.Xintercept = TRUE,
  include.Zintercept = TRUE
)
distr_settings <- list(
  X_distr  = list(distr_name = "mvnorm", distr_params = list(sigma = Sigma_X)),
  Z_distr  = list(distr_name = "mvnorm", distr_params = list(sigma = Sigma_Z)),
  XZ_distr = list(distr_name = "mvnorm", distr_params = list(sigma = Sigma))
)
sim <- simulate_LMMdata(sim_settings = sim_settings, distr_settings = distr_settings)
pairs(cbind(sim$X, sim$Z), main = "Correlated X predictors")


# User-supplied design matrices
n_subj <- 5; n_obs <- 6; n <- n_subj * n_obs
X_user <- matrix(rnorm(n*3), ncol=3)
Z_user <- matrix(rnorm(n*2), ncol=2)
sim_settings <- sim_spec(n_subj = n_subj, n_obs = n_obs, X = X_user, Z = Z_user, beta_coeff = c(1,0.5,-1))
sim <- simulate_LMMdata(sim_settings = sim_settings)


# Copula-based generation
library(copula)
normal_cop <- normalCopula(param = 0.6, dim = 2)
distr_settings <- list(
  X_distr = list(
    distr_name = "copula",
    distr_params = distr_spec(
      copula = normal_cop,
      margins = list(
        list(dist="norm", params=list(mean=0, sd=1)),
        list(dist="norm", params=list(mean=0, sd=2))
      )
    )
  )
)
sim <- simulate_LMMdata(sim_settings = sim_spec(n_subj = 10, n_obs = 3),
                         distr_settings = distr_settings)
plot(sim$X[,2:3], main = "X from Copula-based distribution")


}
\seealso{
\code{\link{simulate_IIDdata}}, \code{\link{distr_spec}}, \code{\link{sim_spec}}.
Also \code{\link{summary.LMMdata}}, \code{\link{print.LMMdata}}, \code{\link{plot.LMMdata}}
for S3 methods applicable to the returned object
}
